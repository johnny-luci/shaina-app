<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”§ ×©×™×™× ×” ××©×™××•×©</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--surface:#141414;--surface2:#1e1e1e;--surface3:#282828;--border:#333;--yellow:#ffd60a;--yellow-dim:rgba(255,214,10,.15);--yellow-hover:rgba(255,214,10,.25);--text:#f5f5f5;--text2:#aaa;--text3:#666;--red:#e2445c;--green:#00c875;--blue:#579bfc;--purple:#a25ddc;--orange:#fdab3d}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex}
/* Sidebar */
.sidebar{width:260px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;height:100vh;position:sticky;top:0}
.sidebar-logo{padding:1.2rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem;font-size:1.2rem;font-weight:700;color:var(--yellow)}
.sidebar-logo span{font-size:1.5rem}
.sidebar-section{padding:.8rem;font-size:.75rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.board-list{flex:1;overflow-y:auto;padding:0 .5rem}
.board-item{padding:.7rem 1rem;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:.5rem;margin-bottom:2px;transition:all .15s;color:var(--text2);font-size:.9rem}
.board-item:hover{background:var(--yellow-dim);color:var(--text)}
.board-item.active{background:var(--yellow-dim);color:var(--yellow);font-weight:600}
.board-item .emoji{font-size:1.1rem}
.add-board-btn{margin:.5rem;padding:.6rem;border-radius:8px;border:1px dashed var(--border);color:var(--text3);cursor:pointer;text-align:center;font-size:.85rem;transition:all .15s}
.add-board-btn:hover{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-dim)}
.sidebar-members{border-top:1px solid var(--border);padding:1rem}
.sidebar-members h4{font-size:.75rem;color:var(--text3);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:1px}
.members-grid{display:flex;flex-wrap:wrap;gap:.3rem}
.member-chip{font-size:1.2rem;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--surface3);cursor:default}
.member-chip[title]:hover{background:var(--yellow-dim)}
/* Main */
.main{flex:1;display:flex;flex-direction:column;min-width:0}
.topbar{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:1rem;background:var(--surface)}
.topbar h2{font-size:1.3rem;flex:1}
.topbar-actions{display:flex;gap:.5rem;align-items:center}
.search-box{background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:.5rem .8rem;color:var(--text);font-size:.85rem;width:200px;transition:border-color .15s}
.search-box:focus{outline:none;border-color:var(--yellow)}
.view-toggle{display:flex;background:var(--surface3);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.view-btn{padding:.45rem .8rem;cursor:pointer;font-size:.8rem;color:var(--text3);transition:all .15s;border:none;background:none}
.view-btn:hover{color:var(--text)}
.view-btn.active{background:var(--yellow);color:#000;font-weight:600}
.btn{padding:.5rem 1rem;border-radius:8px;border:none;cursor:pointer;font-size:.85rem;font-weight:500;transition:all .15s;display:flex;align-items:center;gap:.4rem}
.btn-primary{background:var(--yellow);color:#000}
.btn-primary:hover{filter:brightness(1.1)}
.btn-ghost{background:none;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--yellow);color:var(--yellow)}
/* Board content */
.board-content{flex:1;overflow:auto;padding:1rem 1.5rem}
/* Group */
.group{margin-bottom:1.5rem;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.group-header{display:flex;align-items:center;gap:.8rem;padding:.8rem 1rem;cursor:pointer;transition:background .15s}
.group-header:hover{filter:brightness(1.1)}
.group-toggle{font-size:.8rem;transition:transform .2s}
.group-toggle.collapsed{transform:rotate(-90deg)}
.group-title{font-weight:600;font-size:.95rem;color:#fff}
.group-count{font-size:.75rem;color:rgba(255,255,255,.6);background:rgba(255,255,255,.15);padding:.15rem .5rem;border-radius:10px}
.group-progress{margin-right:auto;width:80px;height:6px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden}
.group-progress-bar{height:100%;background:var(--green);border-radius:3px;transition:width .3s}
.group-actions{display:flex;gap:.3rem}
.group-actions .btn{padding:.3rem .6rem;font-size:.75rem}
/* Table */
.table-header{display:grid;grid-template-columns:2.5fr 1fr 1fr 1fr 1fr 1fr;gap:0;padding:.5rem 1rem;background:var(--surface2);font-size:.75rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.task-row{display:grid;grid-template-columns:2.5fr 1fr 1fr 1fr 1fr 1fr;gap:0;padding:.6rem 1rem;border-bottom:1px solid rgba(255,255,255,.05);transition:background .1s;cursor:pointer}
.task-row:hover{background:var(--yellow-dim)}
.task-row:last-child{border-bottom:none}
.task-cell{display:flex;align-items:center;gap:.4rem;font-size:.85rem;padding:0 .3rem;min-width:0}
.task-name{font-weight:500}
.task-name input{background:none;border:none;color:var(--text);font-size:.85rem;font-weight:500;width:100%;padding:.2rem 0}
.task-name input:focus{outline:none;border-bottom:1px solid var(--yellow)}
/* Assignee */
.assignee{display:flex;align-items:center;gap:.3rem}
.assignee-avatar{font-size:1rem}
.assignee-name{font-size:.8rem;color:var(--text2)}
/* Status pill */
.status-pill{padding:.25rem .6rem;border-radius:4px;font-size:.75rem;font-weight:500;text-align:center;cursor:pointer;transition:filter .15s;white-space:nowrap}
.status-pill:hover{filter:brightness(1.2)}
.status-not-started{background:rgba(121,126,135,.3);color:#c4c4c4}
.status-working{background:rgba(253,171,61,.3);color:#fdab3d}
.status-stuck{background:rgba(226,68,92,.3);color:#e2445c}
.status-review{background:rgba(87,155,252,.3);color:#579bfc}
.status-done{background:rgba(0,200,117,.3);color:#00c875}
/* Priority */
.priority-pill{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600}
.priority-critical{background:rgba(226,68,92,.25);color:#ff7878}
.priority-high{background:rgba(253,171,61,.25);color:#fdab3d}
.priority-medium{background:rgba(87,155,252,.2);color:#579bfc}
.priority-low{background:rgba(0,200,117,.2);color:#00c875}
/* Due date */
.due-date{font-size:.8rem;color:var(--text3)}
.due-date.overdue{color:var(--red)}
.due-date.today{color:var(--yellow)}
/* Tags */
.tags{display:flex;gap:.2rem;flex-wrap:wrap}
.tag{background:var(--yellow-dim);color:var(--yellow);padding:.1rem .4rem;border-radius:3px;font-size:.65rem}
/* Add task row */
.add-task-row{padding:.5rem 1rem;cursor:pointer;color:var(--text3);font-size:.85rem;transition:all .15s;display:flex;align-items:center;gap:.4rem}
.add-task-row:hover{background:var(--yellow-dim);color:var(--yellow)}
/* Kanban */
.kanban{display:flex;gap:1rem;min-height:60vh;padding-bottom:1rem}
.kanban-col{min-width:260px;max-width:260px;background:var(--surface);border-radius:10px;border:1px solid var(--border);display:flex;flex-direction:column}
.kanban-col-header{padding:.8rem;font-size:.85rem;font-weight:600;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.kanban-col-count{background:var(--surface3);padding:.15rem .5rem;border-radius:8px;font-size:.75rem;color:var(--text3)}
.kanban-cards{flex:1;padding:.5rem;overflow-y:auto;min-height:100px}
.kanban-cards.drag-over{background:var(--yellow-dim);border-radius:8px}
.kanban-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.8rem;margin-bottom:.5rem;cursor:grab;transition:all .15s}
.kanban-card:hover{border-color:var(--yellow);transform:translateY(-1px)}
.kanban-card.dragging{opacity:.4;transform:rotate(2deg)}
.kanban-card-title{font-size:.85rem;font-weight:500;margin-bottom:.5rem}
.kanban-card-meta{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.3rem}
.kanban-card-assignee{display:flex;align-items:center;gap:.3rem;font-size:.75rem;color:var(--text2)}
/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;width:90%;max-width:480px;max-height:90vh;overflow-y:auto}
.modal h3{margin-bottom:1rem;color:var(--yellow);display:flex;align-items:center;gap:.5rem}
.form-row{margin-bottom:.8rem}
.form-row label{display:block;font-size:.8rem;color:var(--text3);margin-bottom:.3rem}
.form-row input,.form-row select,.form-row textarea{width:100%;padding:.5rem .7rem;background:var(--surface3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.85rem}
.form-row input:focus,.form-row select:focus,.form-row textarea:focus{outline:none;border-color:var(--yellow)}
.form-row textarea{resize:vertical;min-height:60px}
.modal-btns{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem}
.btn-danger{background:rgba(226,68,92,.2);color:var(--red);border:none;cursor:pointer;padding:.5rem 1rem;border-radius:8px;font-size:.85rem}
.btn-danger:hover{background:rgba(226,68,92,.3)}
/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#555}
.hidden{display:none!important}
.group-tasks.collapsed{display:none}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="sidebar-logo"><span>ğŸ”§</span> ×©×™×™× ×” ××©×™××•×©</div>
  <div class="sidebar-section">×‘×•×¨×“×™×</div>
  <div class="board-list" id="boardList"></div>
  <div class="add-board-btn" onclick="addBoard()">+ ×‘×•×¨×“ ×—×“×©</div>
  <div class="sidebar-members">
    <h4>×”×¦×•×•×ª</h4>
    <div class="members-grid" id="membersGrid"></div>
  </div>
</aside>
<div class="main">
  <div class="topbar">
    <h2 id="boardTitle">×˜×•×¢×Ÿ...</h2>
    <div class="topbar-actions">
      <input class="search-box" type="text" placeholder="ğŸ” ×—×™×¤×•×© ××©×™××•×ª..." id="searchBox" oninput="renderCurrentBoard()">
      <div class="view-toggle">
        <button class="view-btn active" data-view="table" onclick="setView('table')">ğŸ“Š ×˜×‘×œ×”</button>
        <button class="view-btn" data-view="kanban" onclick="setView('kanban')">ğŸ“‹ ×§× ×‘×Ÿ</button>
      </div>
      <button class="btn btn-primary" onclick="openAddTask()">â• ××©×™××”</button>
    </div>
  </div>
  <div class="board-content" id="boardContent"></div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <h3 id="modalTitle">â• ××©×™××” ×—×“×©×”</h3>
    <form id="taskForm" onsubmit="saveTask(event)">
      <input type="hidden" id="fTaskId">
      <input type="hidden" id="fGroupId">
      <div class="form-row"><label>×©× ××©×™××”</label><input id="fName" required placeholder="××” ×¦×¨×™×š ×œ×¢×©×•×ª?"></div>
      <div class="form-row"><label>××—×¨××™</label><select id="fAssignee"></select></div>
      <div class="form-row"><label>×¡×˜×˜×•×¡</label><select id="fStatus">
        <option value="×œ× ×”×ª×—×™×œ">×œ× ×”×ª×—×™×œ</option><option value="×¢×•×‘×“ ×¢×œ ×–×”">×¢×•×‘×“ ×¢×œ ×–×”</option>
        <option value="×ª×§×•×¢">×ª×§×•×¢</option><option value="×‘×‘×“×™×§×”">×‘×‘×“×™×§×”</option><option value="×”×•×©×œ×">×”×•×©×œ×</option>
      </select></div>
      <div class="form-row"><label>×¢×“×™×¤×•×ª</label><select id="fPriority">
        <option value="× ××•×š">ğŸŸ¢ × ××•×š</option><option value="×‘×™× ×•× ×™" selected>ğŸ”µ ×‘×™× ×•× ×™</option>
        <option value="×’×‘×•×”">ğŸŸ  ×’×‘×•×”</option><option value="×§×¨×™×˜×™">ğŸ”´ ×§×¨×™×˜×™</option>
      </select></div>
      <div class="form-row"><label>×ª××¨×™×š ×™×¢×“</label><input type="date" id="fDue"></div>
      <div class="form-row"><label>×ª×’×™×•×ª (×¤×¡×™×§×™×)</label><input id="fTags" placeholder="×¢×™×¦×•×‘, Backend"></div>
      <div class="modal-btns">
        <button type="button" class="btn-danger hidden" id="deleteBtn" onclick="deleteTask()">ğŸ—‘ï¸ ××—×§</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal()">×‘×™×˜×•×œ</button>
        <button type="submit" class="btn btn-primary">ğŸ’¾ ×©××•×¨</button>
      </div>
    </form>
  </div>
</div>

<!-- Board Modal -->
<div class="modal-overlay" id="boardModal">
  <div class="modal">
    <h3>ğŸ“‹ ×‘×•×¨×“ ×—×“×©</h3>
    <form onsubmit="saveBoardModal(event)">
      <div class="form-row"><label>×©× ×”×‘×•×¨×“</label><input id="fBoardName" required placeholder="×©× ×”×¤×¨×•×™×§×˜"></div>
      <div class="form-row"><label>××™××•×’'×™</label><input id="fBoardEmoji" value="ğŸ“‹" maxlength="4"></div>
      <div class="modal-btns">
        <button type="button" class="btn btn-ghost" onclick="closeBoardModal()">×‘×™×˜×•×œ</button>
        <button type="submit" class="btn btn-primary">âœ¨ ×¦×•×¨</button>
      </div>
    </form>
  </div>
</div>

<script>
const STATUSES=['×œ× ×”×ª×—×™×œ','×¢×•×‘×“ ×¢×œ ×–×”','×ª×§×•×¢','×‘×‘×“×™×§×”','×”×•×©×œ×'];
const STATUS_CLASS={'×œ× ×”×ª×—×™×œ':'not-started','×¢×•×‘×“ ×¢×œ ×–×”':'working','×ª×§×•×¢':'stuck','×‘×‘×“×™×§×”':'review','×”×•×©×œ×':'done'};
const PRIORITY_CLASS={'×§×¨×™×˜×™':'critical','×’×‘×•×”':'high','×‘×™× ×•× ×™':'medium','× ××•×š':'low'};
let data,currentBoard=0,currentView='table',draggedEl=null;

async function init(){
  const saved=localStorage.getItem('shaina-data');
  if(saved){data=JSON.parse(saved)}else{
    try{const r=await fetch('data.json');data=await r.json()}
    catch(e){data={boards:[{id:'b1',name:'ğŸ“‹ ×¤×¨×•×™×§×˜ ×¨××©×•×Ÿ',groups:[{id:'g1',name:'×œ×‘×™×¦×•×¢',color:'#ffd60a',tasks:[]}]}],members:[
      {name:'×™×¨×•×Ÿ',avatar:'ğŸ‘¨â€ğŸ’»'},{name:'××œ×¢×“',avatar:'ğŸ§‘â€ğŸ”¬'},{name:'× ×•×¢×',avatar:'ğŸ§‘â€ğŸ¨'},{name:'×“× ×”',avatar:'ğŸ‘©â€ğŸ’¼'},
      {name:'××™×›×œ',avatar:'ğŸ‘©â€ğŸ”§'},{name:'×¢×•××¨',avatar:'ğŸ§‘â€ğŸš€'},{name:'×©×™×¨×”',avatar:'ğŸ‘©â€ğŸ«'},{name:'×™×•× ×™',avatar:'ğŸ§‘â€âš•ï¸'}
    ]}}
  }
  populateMembers();renderSidebar();renderCurrentBoard();
}

function save(){data.lastUpdated=new Date().toISOString();localStorage.setItem('shaina-data',JSON.stringify(data))}
function populateMembers(){
  const g=document.getElementById('membersGrid');const s=document.getElementById('fAssignee');
  g.innerHTML='';s.innerHTML='<option value="">â€” ×‘×—×¨ â€”</option>';
  data.members.forEach(m=>{
    g.innerHTML+=`<div class="member-chip" title="${m.name}">${m.avatar}</div>`;
    s.innerHTML+=`<option value="${m.name}">${m.avatar} ${m.name}</option>`;
  });
}
function renderSidebar(){
  const list=document.getElementById('boardList');
  list.innerHTML=data.boards.map((b,i)=>`<div class="board-item ${i===currentBoard?'active':''}" onclick="switchBoard(${i})"><span class="emoji">${b.name.match(/^\p{Emoji}/u)?.[0]||'ğŸ“‹'}</span>${b.name.replace(/^\p{Emoji}\s*/u,'')}</div>`).join('');
}
function switchBoard(i){currentBoard=i;renderSidebar();renderCurrentBoard()}
function setView(v){currentView=v;document.querySelectorAll('.view-btn').forEach(b=>b.classList.toggle('active',b.dataset.view===v));renderCurrentBoard()}
function getBoard(){return data.boards[currentBoard]}
function getFilteredTasks(tasks){
  const q=document.getElementById('searchBox').value.trim().toLowerCase();
  if(!q)return tasks;
  return tasks.filter(t=>t.name.toLowerCase().includes(q)||t.assignee?.toLowerCase().includes(q)||(t.tags||[]).some(tg=>tg.toLowerCase().includes(q)));
}

function renderCurrentBoard(){
  const board=getBoard();if(!board)return;
  document.getElementById('boardTitle').textContent=board.name;
  if(currentView==='table')renderTable(board);else renderKanban(board);
}

function renderTable(board){
  const c=document.getElementById('boardContent');
  let html='';
  board.groups.forEach(group=>{
    const tasks=getFilteredTasks(group.tasks);
    const done=tasks.filter(t=>t.status==='×”×•×©×œ×').length;
    const pct=tasks.length?Math.round(done/tasks.length*100):0;
    html+=`<div class="group">
      <div class="group-header" style="background:${group.color}20" onclick="toggleGroup('${group.id}')">
        <span class="group-toggle" id="toggle-${group.id}">â–¼</span>
        <span class="group-title" style="color:${group.color}">${group.name}</span>
        <span class="group-count">${tasks.length} ××©×™××•×ª</span>
        <div class="group-progress"><div class="group-progress-bar" style="width:${pct}%"></div></div>
        <span style="font-size:.7rem;color:rgba(255,255,255,.5)">${pct}%</span>
      </div>
      <div class="group-tasks" id="tasks-${group.id}">
        <div class="table-header"><span>××©×™××”</span><span>××—×¨××™</span><span>×¡×˜×˜×•×¡</span><span>×¢×“×™×¤×•×ª</span><span>×ª××¨×™×š ×™×¢×“</span><span>×ª×’×™×•×ª</span></div>
        ${tasks.map(t=>renderTaskRow(t,group.id)).join('')}
        <div class="add-task-row" onclick="openAddTask('${group.id}')">+ ×”×•×¡×£ ××©×™××”</div>
      </div>
    </div>`;
  });
  if(!board.groups.length)html='<div style="text-align:center;padding:3rem;color:var(--text3)">××™×Ÿ ×§×‘×•×¦×•×ª ×¢×“×™×™×Ÿ. <span style="color:var(--yellow);cursor:pointer" onclick="addGroup()">×¦×•×¨ ×§×‘×•×¦×” ×¨××©×•× ×”</span></div>';
  html+=`<div style="margin-top:.5rem"><button class="btn btn-ghost" onclick="addGroup()">+ ×§×‘×•×¦×” ×—×“×©×”</button></div>`;
  c.innerHTML=html;
}

function renderTaskRow(t,gid){
  const m=data.members.find(m=>m.name===t.assignee);
  const avatar=m?m.avatar:'ğŸ‘¤';
  const dueClass=getDueClass(t.dueDate);
  const dueText=t.dueDate?formatDate(t.dueDate):'â€”';
  return `<div class="task-row" draggable="true" data-task="${t.id}" data-group="${gid}" onclick="editTask('${t.id}','${gid}')">
    <div class="task-cell task-name">${t.name}</div>
    <div class="task-cell"><div class="assignee"><span class="assignee-avatar">${avatar}</span><span class="assignee-name">${t.assignee||'â€”'}</span></div></div>
    <div class="task-cell"><span class="status-pill status-${STATUS_CLASS[t.status]||'not-started'}" onclick="event.stopPropagation();cycleStatus('${t.id}','${gid}')">${t.status}</span></div>
    <div class="task-cell"><span class="priority-pill priority-${PRIORITY_CLASS[t.priority]||'medium'}">${t.priority}</span></div>
    <div class="task-cell"><span class="due-date ${dueClass}">${dueText}</span></div>
    <div class="task-cell"><div class="tags">${(t.tags||[]).map(tg=>`<span class="tag">${tg}</span>`).join('')}</div></div>
  </div>`;
}

function renderKanban(board){
  const c=document.getElementById('boardContent');
  const allTasks=board.groups.flatMap(g=>getFilteredTasks(g.tasks).map(t=>({...t,_gid:g.id})));
  let html='<div class="kanban">';
  STATUSES.forEach(status=>{
    const tasks=allTasks.filter(t=>t.status===status);
    html+=`<div class="kanban-col">
      <div class="kanban-col-header"><span>${status}</span><span class="kanban-col-count">${tasks.length}</span></div>
      <div class="kanban-cards" data-status="${status}" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="dropKanban(event,this)">
        ${tasks.map(t=>{
          const m=data.members.find(m=>m.name===t.assignee);
          return `<div class="kanban-card" draggable="true" data-task="${t.id}" data-group="${t._gid}" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="editTask('${t.id}','${t._gid}')">
            <div class="kanban-card-title">${t.name}</div>
            <div class="kanban-card-meta">
              <div class="kanban-card-assignee">${m?m.avatar:'ğŸ‘¤'} ${t.assignee||''}</div>
              <span class="priority-pill priority-${PRIORITY_CLASS[t.priority]}">${t.priority}</span>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  });
  html+='</div>';
  c.innerHTML=html;
}

// Drag and drop
function dragStart(e){e.target.classList.add('dragging');e.dataTransfer.setData('text/plain',JSON.stringify({id:e.target.dataset.task,gid:e.target.dataset.group}))}
function dragEnd(e){e.target.classList.remove('dragging');document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'))}
function dropKanban(e,col){
  e.preventDefault();col.classList.remove('drag-over');
  const d=JSON.parse(e.dataTransfer.getData('text/plain'));
  const newStatus=col.dataset.status;
  const board=getBoard();
  for(const g of board.groups){const t=g.tasks.find(t=>t.id===d.id);if(t){t.status=newStatus;break}}
  save();renderCurrentBoard();
}

function toggleGroup(gid){
  const el=document.getElementById('tasks-'+gid);const tog=document.getElementById('toggle-'+gid);
  el.classList.toggle('collapsed');tog.classList.toggle('collapsed');
}

function cycleStatus(tid,gid){
  const board=getBoard();const group=board.groups.find(g=>g.id===gid);
  if(!group)return;const task=group.tasks.find(t=>t.id===tid);if(!task)return;
  const i=STATUSES.indexOf(task.status);task.status=STATUSES[(i+1)%STATUSES.length];
  save();renderCurrentBoard();
}

function getDueClass(d){
  if(!d)return'';const today=new Date().toISOString().split('T')[0];
  if(d<today)return'overdue';if(d===today)return'today';return'';
}
function formatDate(d){
  if(!d)return'';const dt=new Date(d+'T00:00:00');
  return dt.toLocaleDateString('he-IL',{day:'numeric',month:'short'});
}

// Modal
function openAddTask(gid){
  document.getElementById('modalTitle').textContent='â• ××©×™××” ×—×“×©×”';
  document.getElementById('taskForm').reset();
  document.getElementById('fTaskId').value='';
  document.getElementById('fGroupId').value=gid||getBoard().groups[0]?.id||'';
  document.getElementById('deleteBtn').classList.add('hidden');
  document.getElementById('taskModal').classList.add('active');
}

function editTask(tid,gid){
  const board=getBoard();const group=board.groups.find(g=>g.id===gid);
  if(!group)return;const task=group.tasks.find(t=>t.id===tid);if(!task)return;
  document.getElementById('modalTitle').textContent='âœï¸ ×¢×¨×™×›×ª ××©×™××”';
  document.getElementById('fTaskId').value=task.id;
  document.getElementById('fGroupId').value=gid;
  document.getElementById('fName').value=task.name;
  document.getElementById('fAssignee').value=task.assignee||'';
  document.getElementById('fStatus').value=task.status;
  document.getElementById('fPriority').value=task.priority;
  document.getElementById('fDue').value=task.dueDate||'';
  document.getElementById('fTags').value=(task.tags||[]).join(', ');
  document.getElementById('deleteBtn').classList.remove('hidden');
  document.getElementById('taskModal').classList.add('active');
}

function saveTask(e){
  e.preventDefault();
  const tid=document.getElementById('fTaskId').value;
  const gid=document.getElementById('fGroupId').value;
  const taskData={
    id:tid||'t'+Date.now(),
    name:document.getElementById('fName').value,
    assignee:document.getElementById('fAssignee').value,
    status:document.getElementById('fStatus').value,
    priority:document.getElementById('fPriority').value,
    dueDate:document.getElementById('fDue').value||null,
    tags:document.getElementById('fTags').value.split(',').map(s=>s.trim()).filter(Boolean)
  };
  const board=getBoard();const group=board.groups.find(g=>g.id===gid);
  if(!group)return;
  if(tid){const i=group.tasks.findIndex(t=>t.id===tid);if(i>=0)group.tasks[i]={...group.tasks[i],...taskData}}
  else{group.tasks.push(taskData)}
  save();closeModal();renderCurrentBoard();
}

function deleteTask(){
  const tid=document.getElementById('fTaskId').value;
  const gid=document.getElementById('fGroupId').value;
  if(!tid||!confirm('×œ××—×•×§ ××ª ×”××©×™××”?'))return;
  const board=getBoard();const group=board.groups.find(g=>g.id===gid);
  if(group)group.tasks=group.tasks.filter(t=>t.id!==tid);
  save();closeModal();renderCurrentBoard();
}

function closeModal(){document.getElementById('taskModal').classList.remove('active')}

function addGroup(){
  const name=prompt('×©× ×”×§×‘×•×¦×”:');if(!name)return;
  const colors=['#ffd60a','#579bfc','#a25ddc','#00c875','#e2445c','#fdab3d','#ff642e'];
  getBoard().groups.push({id:'g'+Date.now(),name,color:colors[Math.floor(Math.random()*colors.length)],tasks:[]});
  save();renderCurrentBoard();
}

function addBoard(){document.getElementById('boardModal').classList.add('active')}
function closeBoardModal(){document.getElementById('boardModal').classList.remove('active')}
function saveBoardModal(e){
  e.preventDefault();
  const name=document.getElementById('fBoardEmoji').value+' '+document.getElementById('fBoardName').value;
  data.boards.push({id:'b'+Date.now(),name,groups:[{id:'g'+Date.now(),name:'×›×œ×œ×™',color:'#ffd60a',tasks:[]}]});
  save();currentBoard=data.boards.length-1;renderSidebar();renderCurrentBoard();closeBoardModal();
}

document.getElementById('taskModal').addEventListener('click',e=>{if(e.target.id==='taskModal')closeModal()});
document.getElementById('boardModal').addEventListener('click',e=>{if(e.target.id==='boardModal')closeBoardModal()});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeModal();closeBoardModal()}});

init();
</script>
</body>
</html>
